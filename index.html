<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="UTF-8" />
  <title>MADDAG ‚Äì privat opskriftsv√¶rkt√∏j</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg-red: #b30000;
      --bg-red-soft: #f7e5e5;
      --card-bg: #ffffff;
      --card-border: #e3c7c7;
      --accent-red: #d00000;
      --accent-red-soft: #fbe9e9;
      --accent-navy: #0b1c3b;
      --accent-navy-soft: #192845;
      --text-main: #111111;
      --text-muted: #555555;
      --chip-bg: #f0f0f5;
      --chip-border: #d0d3dd;
      --shadow-soft: 0 18px 45px rgba(0, 0, 0, 0.16);
      --radius-xl: 22px;
      --radius-lg: 18px;
      --radius-pill: 999px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: var(--text-main);
      background: radial-gradient(circle at top, #ffe5e5 0, #f7d2d2 22%, #f1c1c1 33%, #f7e5e5 46%, #f8f8fb 76%);
      min-height: 100vh;
      position: relative;
      overflow-x: hidden;
    }

    /* Dekorative bobler ‚Äì masser af variation */
    .bg-bubbles {
      position: fixed;
      inset: -200px -120px;
      pointer-events: none;
      z-index: 0;
      overflow: hidden;
    }

    .bg-bubbles span {
      position: absolute;
      border-radius: 50%;
      filter: blur(1px);
      opacity: 0.18;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.9), transparent 60%);
      mix-blend-mode: multiply;
    }

    /* R√∏de bobler */
    .bg-bubbles span.b1 { width: 280px; height: 280px; background: radial-gradient(circle, rgba(179,0,0,0.85), transparent 65%); top: -40px; left: -80px; opacity: 0.45; }
    .bg-bubbles span.b2 { width: 220px; height: 220px; background: radial-gradient(circle, rgba(208,0,0,0.75), transparent 70%); top: 40%; left: -60px; opacity: 0.35; }
    .bg-bubbles span.b3 { width: 260px; height: 260px; background: radial-gradient(circle, rgba(179,0,0,0.55), transparent 68%); bottom: -80px; right: -40px; opacity: 0.4; }

    /* Navy-bl√• bobler */
    .bg-bubbles span.b4 { width: 320px; height: 320px; background: radial-gradient(circle, rgba(11,28,59,0.85), transparent 68%); top: -120px; right: 10%; opacity: 0.35; }
    .bg-bubbles span.b5 { width: 190px; height: 190px; background: radial-gradient(circle, rgba(25,40,69,0.6), transparent 70%); top: 55%; right: 15%; opacity: 0.5; }
    .bg-bubbles span.b6 { width: 140px; height: 140px; background: radial-gradient(circle, rgba(25,40,69,0.3), transparent 70%); bottom: 10%; left: 20%; opacity: 0.7; }

    /* Gr√• & transparente bobler i forskellige opaciteter */
    .bg-bubbles span.b7 { width: 260px; height: 260px; background: radial-gradient(circle, rgba(0,0,0,0.18), transparent 70%); top: 15%; left: 55%; opacity: 0.2; }
    .bg-bubbles span.b8 { width: 110px; height: 110px; background: radial-gradient(circle, rgba(255,255,255,0.08), transparent 60%); top: 70%; left: 65%; opacity: 0.8; border: 1px solid rgba(0,0,0,0.08); }
    .bg-bubbles span.b9 { width: 90px; height: 90px; background: radial-gradient(circle, rgba(0,0,0,0.05), transparent 70%); top: 25%; right: 30%; opacity: 0.25; border: 1px solid rgba(0,0,0,0.06); }
    .bg-bubbles span.b10 { width: 180px; height: 180px; background: radial-gradient(circle, rgba(255,255,255,0.0), transparent 80%); border: 1px solid rgba(0,0,0,0.06); top: 60%; left: 5%; opacity: 0.4; }
    .bg-bubbles span.b11 { width: 130px; height: 130px; background: radial-gradient(circle, rgba(0,0,0,0.12), transparent 80%); bottom: 5%; right: 35%; opacity: 0.6; }
    .bg-bubbles span.b12 { width: 210px; height: 210px; background: radial-gradient(circle, rgba(25,40,69,0.15), transparent 80%); top: 35%; left: 35%; opacity: 0.3; }

    /* NAVY banner */
    .top-banner {
      position: relative;
      z-index: 2;
      background: var(--accent-navy);
      padding: 18px 16px;
      box-shadow: 0 10px 26px rgba(0,0,0,0.3);
    }

    .top-banner-title {
      max-width: 1100px;
      margin: 0 auto;
      text-align: left;
      color: #ffffff;
      font-weight: 900;
      letter-spacing: 0.45em;
      font-size: 2.2rem;
      text-transform: uppercase;
    }

    .app-shell {
      position: relative;
      z-index: 3;
      max-width: 1100px;
      margin: 26px auto 40px;
      padding: 0 16px 40px;
    }

    .search-card {
      background: var(--card-bg);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-soft);
      padding: 20px 22px 18px;
      border: 1px solid var(--card-border);
    }

    .search-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 14px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }

    .search-title {
      font-size: 0.9rem;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--accent-navy-soft);
    }

    .search-main-row {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 6px;
      flex-wrap: wrap;
    }

    .search-input-wrapper {
      flex: 1;
      position: relative;
    }

    .search-input-wrapper input {
      width: 100%;
      border-radius: var(--radius-pill);
      border: 1px solid #d4d7e2;
      padding: 10px 16px;
      font-size: 0.95rem;
      outline: none;
      background: #fdfdfd;
      transition: border-color 0.15s, box-shadow 0.15s, background 0.15s;
    }

    .search-input-wrapper input:focus {
      border-color: var(--accent-red);
      box-shadow: 0 0 0 2px rgba(179,0,0,0.1);
      background: #ffffff;
    }

    .btn {
      border-radius: var(--radius-pill);
      border: none;
      padding: 9px 18px;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: background 0.15s, box-shadow 0.15s, transform 0.08s;
      white-space: nowrap;
    }

    .btn:active {
      transform: translateY(1px);
      box-shadow: none;
    }

    .btn-primary {
      background: var(--accent-red);
      color: #fff;
      box-shadow: 0 8px 18px rgba(179,0,0,0.35);
    }

    .btn-primary:hover {
      background: #bf0000;
    }

    .btn-ghost {
      background: #f6f6f8;
      color: var(--text-main);
      border: 1px solid #dedfe8;
      box-shadow: none;
    }

    .btn-ghost:hover {
      background: #ececf2;
    }

    .icon-circle {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      border: 2px solid #fff;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: #ffffff22;
      font-size: 0.8rem;
    }

    .search-meta-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
      margin-top: 8px;
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .search-meta-left {
      display: flex;
      align-items: center;
      gap: 18px;
      flex-wrap: wrap;
    }

    .checkbox-inline {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      user-select: none;
    }

    .checkbox-inline input {
      accent-color: var(--accent-red);
    }

    .chip-counter {
      padding: 4px 10px;
      border-radius: var(--radius-pill);
      background: #f3f4fa;
      border: 1px solid #d6d8e6;
    }

    .sort-wrapper {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.82rem;
      color: var(--text-muted);
    }

    .sort-wrapper select {
      border-radius: var(--radius-pill);
      border: 1px solid #d4d7e2;
      padding: 5px 11px;
      font-size: 0.82rem;
      background: #fff;
      outline: none;
    }

    .ingredient-chips {
      margin-top: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .chip {
      border-radius: var(--radius-pill);
      background: var(--chip-bg);
      border: 1px solid var(--chip-border);
      padding: 4px 10px;
      font-size: 0.78rem;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .chip button {
      border: none;
      background: transparent;
      cursor: pointer;
      padding: 0;
      font-size: 0.85rem;
      line-height: 1;
      color: #888;
    }

    .results-section {
      margin-top: 26px;
    }

    .results-header-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 10px;
    }

    .results-title {
      font-size: 0.95rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--accent-navy-soft);
      font-weight: 600;
    }

    .results-count {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .results-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .recipe-card {
      background: linear-gradient(90deg, rgba(255,255,255,0.98), rgba(255,255,255,0.95));
      border-radius: var(--radius-xl);
      border: 1px solid #f0d6d6;
      padding: 14px 16px 14px 18px;
      display: flex;
      flex-direction: column;
      box-shadow: 0 10px 24px rgba(0,0,0,0.06);
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }

    .recipe-card::before {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(90deg, rgba(179,0,0,0.02), transparent 30%, transparent 70%, rgba(11,28,59,0.03));
      pointer-events: none;
    }

    .recipe-summary-row {
      display: grid;
      grid-template-columns: minmax(0, 1.6fr) auto;
      gap: 18px;
      align-items: center;
    }

    .recipe-main-info {
      position: relative;
      z-index: 1;
    }

    .recipe-title {
      font-weight: 600;
      font-size: 1rem;
      margin-bottom: 2px;
    }

    .recipe-subtitle {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-bottom: 6px;
    }

    .recipe-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 4px;
    }

    .tag-pill {
      font-size: 0.75rem;
      padding: 3px 9px;
      border-radius: var(--radius-pill);
      background: #f5f5f7;
      border: 1px solid #e0e2eb;
      color: #555;
    }

    .time-pill-column {
      position: relative;
      z-index: 1;
      justify-self: end;
    }

    .time-pill {
      background: var(--accent-red-soft);
      border-radius: 18px;
      padding: 8px 12px 8px;
      border: 1px solid #f0c6c6;
      font-size: 0.8rem;
      display: inline-block;
      min-width: 145px;
    }

    .time-pill-row {
      display: flex;
      justify-content: space-between;
      gap: 12px;
    }

    .time-pill-row + .time-pill-row {
      margin-top: 2px;
    }

    .time-label {
      color: var(--accent-navy-soft);
      font-weight: 600;
    }

    .time-value {
      font-variant-numeric: tabular-nums;
    }

    .chevron {
      position: absolute;
      right: 0;
      bottom: 0;
      font-size: 1rem;
      color: #b89a9a;
      transform: translate(4px, 4px);
    }

    .recipe-card.expanded .chevron {
      transform: translate(4px, 4px) rotate(180deg);
    }

    .recipe-details {
      margin-top: 12px;
      border-top: 1px solid #f0dede;
      padding-top: 12px;
      font-size: 0.9rem;
      position: relative;
      z-index: 1;
    }

    .recipe-details-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 26px;
      align-items: flex-start;
    }

    .details-column h4 {
      margin: 0 0 6px;
      font-size: 0.9rem;
    }

    .details-column ul {
      margin: 0 0 8px 18px;
      padding: 0;
    }

    .details-column li {
      margin-bottom: 3px;
    }

    .servings-row {
      font-size: 0.85rem;
      margin-bottom: 8px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
    }

    .servings-row strong {
      margin-right: 4px;
    }

    .servings-row select {
      border-radius: var(--radius-pill);
      border: 1px solid #d4d7e2;
      padding: 3px 11px;
      font-size: 0.85rem;
      background: #fff;
      outline: none;
    }

    .notes {
      margin-top: 10px;
      font-size: 0.85rem;
      color: var(--text-muted);
      font-style: italic;
    }

    .empty-state {
      margin-top: 8px;
      font-size: 0.88rem;
      color: var(--text-muted);
    }

    /* Responsive */
    @media (max-width: 768px) {
      .app-shell {
        margin-top: 18px;
      }

      .top-banner-title {
        font-size: 1.6rem;
        letter-spacing: 0.3em;
      }

      .search-card {
        padding: 16px 14px 14px;
      }

      .search-main-row {
        flex-direction: column;
        align-items: stretch;
      }

      .search-header {
        flex-direction: column;
        align-items: flex-start;
      }

      .search-meta-row {
        align-items: flex-start;
      }

      .recipe-summary-row {
        grid-template-columns: minmax(0, 1fr);
        gap: 10px;
      }

      .time-pill-column {
        justify-self: flex-start;
      }

      .recipe-details-grid {
        grid-template-columns: 1fr;
        gap: 18px;
      }
    }

    @media (max-width: 480px) {
      .top-banner-title {
        font-size: 1.4rem;
        letter-spacing: 0.22em;
      }

      .time-pill {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="bg-bubbles">
    <span class="b1"></span>
    <span class="b2"></span>
    <span class="b3"></span>
    <span class="b4"></span>
    <span class="b5"></span>
    <span class="b6"></span>
    <span class="b7"></span>
    <span class="b8"></span>
    <span class="b9"></span>
    <span class="b10"></span>
    <span class="b11"></span>
    <span class="b12"></span>
  </div>

  <header class="top-banner">
    <div class="top-banner-title">MADDAG</div>
  </header>

  <main class="app-shell">
    <section class="search-card">
      <div class="search-header">
        <div class="search-title">Tilf√∏j ingrediens</div>
      </div>

      <div class="search-main-row">
        <div class="search-input-wrapper">
          <input
            id="ingredient-input"
            type="text"
            list="ingredient-suggestions"
            placeholder="fx kartofler"
            autocomplete="off"
          />
          <datalist id="ingredient-suggestions"></datalist>
        </div>

        <button class="btn btn-ghost" id="add-ingredient-btn">
          <span class="icon-circle">+</span>
          Tilf√∏j
        </button>

        <button class="btn btn-ghost" id="reset-ingredients-btn">
          Nulstil ingredienser
        </button>
      </div>

      <div class="ingredient-chips" id="ingredient-chips"></div>

      <div class="search-meta-row">
        <div class="search-meta-left">
          <button class="btn btn-primary" id="search-btn">
            <span class="icon-circle">üîç</span>
            Find opskrifter
          </button>

          <label class="checkbox-inline">
            <input type="checkbox" id="allow-missing-checkbox" checked />
            <span>Tillad 1 manglende ingrediens</span>
          </label>

          <div class="chip-counter" id="selected-counter">
            Ingen ingredienser tilf√∏jet endnu.
          </div>
        </div>

        <div class="sort-wrapper">
          <span>Sort√©r:</span>
          <select id="sort-select">
            <option value="best">Bedste match</option>
            <option value="time-asc">Kortest tid</option>
            <option value="time-desc">L√¶ngst tid</option>
          </select>
        </div>
      </div>
    </section>

    <section class="results-section">
      <div class="results-header-row">
        <div class="results-title">Forslag</div>
        <div class="results-count" id="results-count"></div>
      </div>
      <div id="results-list" class="results-list"></div>
      <div id="empty-state" class="empty-state">
        Tilf√∏j √©n eller flere ingredienser og tryk ‚ÄúFind opskrifter‚Äù for at se forslag.
      </div>
    </section>
  </main>

 <script>
  const ingredientInput = document.getElementById("ingredient-input");
  const addIngredientBtn = document.getElementById("add-ingredient-btn");
  const resetIngredientsBtn = document.getElementById("reset-ingredients-btn");
  const ingredientChips = document.getElementById("ingredient-chips");
  const searchBtn = document.getElementById("search-btn");
  const allowMissingCheckbox = document.getElementById("allow-missing-checkbox");
  const sortSelect = document.getElementById("sort-select");
  const resultsList = document.getElementById("results-list");
  const resultsCount = document.getElementById("results-count");
  const emptyState = document.getElementById("empty-state");
  const selectedCounter = document.getElementById("selected-counter");
  const suggestionsList = document.getElementById("ingredient-suggestions");

  let recipes = [];
  let selectedIngredients = [];
  let allKeywordsSet = new Set();

  const normalizeText = (str) =>
    (str || "").toString().toLowerCase().trim();

  /* Alias-grupper ‚Äì synonymer */
  const aliasGroups = [
    ["kylling", "kyllingebryst", "kyllingeinderfilet", "kyllingel√•r", "kyllingel√•r og overl√•r", "kyllingek√∏d", "kyllingefars"],
    ["karry", "karrypulver", "karrypasta"],
    ["oksek√∏d", "hakket oksek√∏d", "oksebov", "okseklump", "okseskank", "oksesteg", "oksegryde"],
    ["svinek√∏d", "hakket svinek√∏d", "svinek√¶ber", "svinesteg", "svinefilet", "svinekoteletter"],
    ["fisk", "laks", "torsk", "hvid fisk", "fiskefars", "fiskefrikadeller"],
    ["b√¶lgfrugter", "kik√¶rter", "linser", "kidneyb√∏nner", "sorte b√∏nner", "hvide b√∏nner"]
  ];

  const expansionMap = {};
  aliasGroups.forEach(group => {
    const normalizedGroup = group.map(normalizeText);
    normalizedGroup.forEach(term => {
      expansionMap[term] = normalizedGroup;
    });
  });

  function getIngredientVariants(term) {
    const t = normalizeText(term);
    return expansionMap[t] || [t];
  }

  function collectTokens(text, set) {
    normalizeText(text)
      .split(/[^a-z√¶√∏√•0-9]+/g)
      .filter(Boolean)
      .forEach(t => set.add(t));
  }

  function updateSelectedCounter() {
    if (selectedIngredients.length === 0) {
      selectedCounter.textContent = "Ingen ingredienser tilf√∏jet endnu.";
    } else if (selectedIngredients.length === 1) {
      selectedCounter.textContent = "1 ingrediens valgt.";
    } else {
      selectedCounter.textContent = `${selectedIngredients.length} ingredienser valgt.`;
    }
  }

  function renderIngredientChips() {
    ingredientChips.innerHTML = "";
    selectedIngredients.forEach((item, index) => {
      const chip = document.createElement("div");
      chip.className = "chip";
      chip.innerHTML = `<span>${item.label}</span>`;
      const btn = document.createElement("button");
      btn.type = "button";
      btn.textContent = "√ó";
      btn.addEventListener("click", (e) => {
        e.stopPropagation();
        selectedIngredients.splice(index, 1);
        renderIngredientChips();
        updateSelectedCounter();
      });
      chip.appendChild(btn);
      ingredientChips.appendChild(chip);
    });
  }

  function addIngredientFromInput() {
    const value = ingredientInput.value.trim();
    if (!value) return;
    const normalized = normalizeText(value);
    if (selectedIngredients.some((i) => i.normalized === normalized)) {
      ingredientInput.value = "";
      return;
    }
    selectedIngredients.push({ label: value, normalized });
    ingredientInput.value = "";
    renderIngredientChips();
    updateSelectedCounter();
  }

  addIngredientBtn.addEventListener("click", () => {
    addIngredientFromInput();
    ingredientInput.focus();
  });

  ingredientInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      e.preventDefault();
      addIngredientFromInput();
    }
  });

  resetIngredientsBtn.addEventListener("click", () => {
    selectedIngredients = [];
    renderIngredientChips();
    updateSelectedCounter();
    resultsList.innerHTML = "";
    resultsCount.textContent = "";
    emptyState.style.display = "block";
  });

  function buildSuggestionsDatalist() {
    suggestionsList.innerHTML = "";
    const sorted = Array.from(allKeywordsSet).sort();
    sorted.forEach((kw) => {
      const opt = document.createElement("option");
      opt.value = kw;
      suggestionsList.appendChild(opt);
    });
  }

  function scaleAmount(amount, factor) {
    if (!amount || factor === 1) return amount;
    const regex = /(\d+([.,]\d+)?)/g;
    return amount.replace(regex, (match) => {
      const num = parseFloat(match.replace(",", "."));
      if (isNaN(num)) return match;
      let scaled = num * factor;
      const rounded = Math.round(scaled * 2) / 2;
      let str = rounded.toString().replace(".", ",");
      if (str.endsWith(",0")) str = str.slice(0, -2);
      return str;
    });
  }

  /** Strammere match-logik:
   *  - vi matcher mod recipe._tokens (kort, pr√¶cist s√¶t)
   *  - en valgt ingrediens er KUN match, hvis en af dens aliaser findes som token.
   */
  function calculateMatch(recipe) {
    const tokens = recipe._tokens || [];
    const total = selectedIngredients.length;
    if (total === 0) return { matches: 0, missing: 0 };

    let matches = 0;
    selectedIngredients.forEach((ing) => {
      const variants = getIngredientVariants(ing.normalized);
      const found = variants.some((v) => tokens.includes(v));
      if (found) matches++;
    });
    const missing = total - matches;
    return { matches, missing };
  }

  function renderResults(items) {
    resultsList.innerHTML = "";
    if (!items || items.length === 0) {
      resultsCount.textContent = "";
      emptyState.style.display = "block";
      return;
    }
    emptyState.style.display = "none";
    resultsCount.textContent = `${items.length} resultater`;

    items.forEach(({ recipe }) => {
      const card = document.createElement("article");
      card.className = "recipe-card";

      const summaryRow = document.createElement("div");
      summaryRow.className = "recipe-summary-row";

      const mainInfo = document.createElement("div");
      mainInfo.className = "recipe-main-info";
      const titleEl = document.createElement("div");
      titleEl.className = "recipe-title";
      titleEl.textContent = recipe.title;
      const subtitleEl = document.createElement("div");
      subtitleEl.className = "recipe-subtitle";
      subtitleEl.textContent = `Opskrift til ${recipe.servings} pers.`;

      const tagsWrap = document.createElement("div");
      tagsWrap.className = "recipe-tags";
      (recipe.tags || []).forEach((tag) => {
        const span = document.createElement("span");
        span.className = "tag-pill";
        span.textContent = tag;
        tagsWrap.appendChild(span);
      });

      mainInfo.appendChild(titleEl);
      mainInfo.appendChild(subtitleEl);
      mainInfo.appendChild(tagsWrap);

      const timeCol = document.createElement("div");
      timeCol.className = "time-pill-column";
      const timePill = document.createElement("div");
      timePill.className = "time-pill";

      const row1 = document.createElement("div");
      row1.className = "time-pill-row";
      row1.innerHTML = `<span class="time-label">Forberedelse</span><span class="time-value">${recipe.prepTime || ""}</span>`;

      const row2 = document.createElement("div");
      row2.className = "time-pill-row";
      row2.innerHTML = `<span class="time-label">Tilberedning</span><span class="time-value">${recipe.cookTime || ""}</span>`;

      const row3 = document.createElement("div");
      row3.className = "time-pill-row";
      row3.innerHTML = `<span class="time-label">I alt</span><span class="time-value">${recipe.time || ""}</span>`;

      timePill.appendChild(row1);
      timePill.appendChild(row2);
      timePill.appendChild(row3);
      timeCol.appendChild(timePill);

      const chev = document.createElement("div");
      chev.className = "chevron";
      chev.textContent = "‚ñæ";
      timeCol.appendChild(chev);

      summaryRow.appendChild(mainInfo);
      summaryRow.appendChild(timeCol);

      const details = document.createElement("div");
      details.className = "recipe-details";
      details.style.display = "none";

      card.appendChild(summaryRow);
      card.appendChild(details);

      function renderDetails(servingsTarget) {
        const servings = recipe.servings || servingsTarget || 4;
        let target = servingsTarget || servings;
        details.innerHTML = "";

        const servingsRow = document.createElement("div");
        servingsRow.className = "servings-row";
        servingsRow.innerHTML = `<span>Opskriften er skrevet til ${servings} personer.</span>`;
        const scaleLabel = document.createElement("strong");
        scaleLabel.textContent = "Skal√©r til:";
        servingsRow.appendChild(scaleLabel);

        const select = document.createElement("select");
        for (let s = 2; s <= 10; s++) {
          const opt = document.createElement("option");
          opt.value = s;
          opt.textContent = `${s} pers.`;
          if (s === target) opt.selected = true;
          select.appendChild(opt);
        }
        servingsRow.appendChild(select);
        details.appendChild(servingsRow);

        const grid = document.createElement("div");
        grid.className = "recipe-details-grid";

        const colIng = document.createElement("div");
        colIng.className = "details-column";
        const hIng = document.createElement("h4");
        hIng.textContent = "Ingredienser";
        colIng.appendChild(hIng);

        const listIng = document.createElement("ul");
        const factor = target / (servings || target);
        (recipe.ingredients || []).forEach((ing) => {
          const li = document.createElement("li");
          const amount = scaleAmount(ing.amount, factor);
          li.textContent = `${amount ? amount + " " : ""}${ing.name}`;
          listIng.appendChild(li);
        });
        colIng.appendChild(listIng);

        const colSteps = document.createElement("div");
        colSteps.className = "details-column";
        const hSteps = document.createElement("h4");
        hSteps.textContent = "Fremgangsm√•de";
        colSteps.appendChild(hSteps);

        const listSteps = document.createElement("ol");
        (recipe.instructions || []).forEach((step) => {
          const li = document.createElement("li");
          li.textContent = step;
          listSteps.appendChild(li);
        });
        colSteps.appendChild(listSteps);

        grid.appendChild(colIng);
        grid.appendChild(colSteps);
        details.appendChild(grid);

        if (recipe.notes) {
          const notesEl = document.createElement("div");
          notesEl.className = "notes";
          notesEl.textContent = recipe.notes;
          details.appendChild(notesEl);
        }

        select.addEventListener("change", () => {
          const newTarget = parseInt(select.value, 10);
          renderDetails(newTarget);
        });
      }

      let expanded = false;
      card.addEventListener("click", (e) => {
        if (e.target.tagName.toLowerCase() === "select") return;
        expanded = !expanded;
        if (expanded) {
          renderDetails(recipe.servings || 4);
          details.style.display = "block";
          card.classList.add("expanded");
        } else {
          details.style.display = "none";
          card.classList.remove("expanded");
        }
      });

      resultsList.appendChild(card);
    });
  }

  function performSearch() {
    if (!recipes || recipes.length === 0) return;

    const allowMissing = allowMissingCheckbox.checked;
    const total = selectedIngredients.length;

    const resultsWithMeta = recipes.map((recipe) => {
      const { matches, missing } = calculateMatch(recipe);
      return { recipe, matches, missing };
    });

    let filtered = resultsWithMeta.filter(({ matches, missing }) => {
      if (total === 0) return false;
      const allowedMissing = allowMissing ? 1 : 0;
      if (missing > allowedMissing) return false;
      return matches > 0;
    });

    const sortMode = sortSelect.value;
    filtered.sort((a, b) => {
      const timeA = a.recipe.timeMinutes || 9999;
      const timeB = b.recipe.timeMinutes || 9999;
      if (sortMode === "time-asc") {
        return timeA - timeB;
      } else if (sortMode === "time-desc") {
        return timeB - timeA;
      } else {
        if (b.matches !== a.matches) return b.matches - a.matches;
        const missingDiff = a.missing - b.missing;
        if (missingDiff !== 0) return missingDiff;
        return timeA - timeB;
      }
    });

    renderResults(filtered);
  }

  searchBtn.addEventListener("click", performSearch);
  allowMissingCheckbox.addEventListener("change", performSearch);
  sortSelect.addEventListener("change", performSearch);

  // Hent recipes.json og byg tokens
  fetch("recipes.json")
    .then((res) => res.json())
    .then((data) => {
      recipes = (data || []).map((r) => {
        const tokenSet = new Set();
        (r.ingredientKeywords || []).forEach((kw) => collectTokens(kw, tokenSet));
        (r.ingredients || []).forEach((ing) => collectTokens(ing.name, tokenSet));
        const tokens = Array.from(tokenSet);
        tokens.forEach((t) => allKeywordsSet.add(t));
        return { ...r, _tokens: tokens };
      });
      buildSuggestionsDatalist();
    })
    .catch((err) => {
      console.error("Kunne ikke indl√¶se recipes.json", err);
    });
</script>
</body>
</html>
