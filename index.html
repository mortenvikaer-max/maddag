<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Opskriftsv√¶rkt√∏j</title>
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      line-height: 1.5;
      color: #111827;
    }

    body {
      margin: 0;
      padding: 0;
      background: #fef2f2;
      color: #111827;
    }

    /* Bl√∏de, matte cirkler i siderne (r√∏dlig) */
    body::before,
    body::after {
      content: "";
      position: fixed;
      width: 360px;
      height: 360px;
      border-radius: 50%;
      background: radial-gradient(
        circle at center,
        rgba(254, 202, 202, 0.7),
        rgba(254, 202, 202, 0)
      );
      opacity: 0.7;
      filter: blur(2px);
      pointer-events: none;
      z-index: 0;
    }

    body::before {
      top: -80px;
      left: -60px;
    }

    body::after {
      bottom: -80px;
      right: -60px;
    }

    .page {
      position: relative;
      z-index: 1;
      max-width: 1000px;
      margin: 0 auto;
      padding: 24px 16px 48px;
    }

    /* Status holdes skjult, s√• du ikke ser "Indl√¶ste X opskrifter" */
    .status {
      display: none;
    }

    .card {
      background: #fff7f7;
      backdrop-filter: blur(8px);
      border-radius: 18px;
      padding: 16px 16px 20px;
      box-shadow: 0 14px 30px rgba(185, 28, 28, 0.18);
      margin-bottom: 24px;
      border: 1px solid rgba(254, 202, 202, 0.9);
    }

    label {
      display: block;
      font-weight: 600;
      margin-bottom: 6px;
    }

    .input-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 6px;
    }

    input[type="text"] {
      flex: 1 1 200px;
      padding: 10px 12px;
      font-size: 0.95rem;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      box-sizing: border-box;
      background: #fef2f2;
    }

    input[type="text"]:focus {
      outline: none;
      border-color: #b91c1c;
      box-shadow: 0 0 0 2px rgba(248, 113, 113, 0.45);
      background: #ffffff;
    }

    button {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 9px 16px;
      font-size: 0.9rem;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      background: #ef4444;
      color: #fff1f2;
      white-space: nowrap;
      transition: transform 0.05s ease-out, box-shadow 0.05s ease-out,
        background 0.12s ease-in;
      box-shadow: 0 6px 16px rgba(220, 38, 38, 0.35);
    }

    button:hover {
      background: #dc2626;
      transform: translateY(-1px);
      box-shadow: 0 10px 24px rgba(185, 28, 28, 0.5);
    }

    button:active {
      transform: translateY(0);
      box-shadow: 0 4px 12px rgba(185, 28, 28, 0.28);
    }

    .button--ghost {
      background: #fee2e2;
      color: #b91c1c;
      box-shadow: none;
      border: 1px solid #fecaca;
    }

    .button--ghost:hover {
      background: #fecaca;
      box-shadow: none;
    }

    .chips {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 8px;
      min-height: 24px;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      background: #fee2e2;
      font-size: 0.8rem;
      color: #b91c1c;
      border: 1px solid #fecaca;
    }

    .chip span {
      text-transform: lowercase;
    }

    .chip-remove {
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 0.85rem;
      line-height: 1;
      padding: 0;
      color: #9f1239;
    }

    .filters-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin-top: 6px;
    }

    .filters-row label {
      margin-bottom: 0;
      font-weight: 500;
      font-size: 0.8rem;
      color: #4b5563;
    }

    select {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      font-size: 0.85rem;
      background: #fef2f2;
      color: #111827;
    }

    .small {
      font-size: 0.78rem;
      color: #6b7280;
    }

    /* Autocomplete-forslag */
    .suggestions {
      margin-top: 2px;
      margin-bottom: 6px;
      max-width: 260px;
      background: #ffffff;
      border-radius: 12px;
      border: 1px solid #fecaca;
      box-shadow: 0 8px 18px rgba(248, 113, 113, 0.22);
      display: none;
      overflow: hidden;
      font-size: 0.8rem;
    }

    .suggestion-item {
      padding: 6px 10px;
      cursor: pointer;
      color: #7f1d1d;
    }

    .suggestion-item:hover {
      background: #fee2e2;
    }

    .results-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 10px;
      gap: 8px;
    }

    .results-header h2 {
      margin: 0;
      font-size: 1.1rem;
    }

    .results-count {
      font-size: 0.85rem;
      color: #6b7280;
    }

    .results {
      display: grid;
      grid-template-columns: minmax(0, 1fr);
      gap: 14px;
    }

    .recipe-card {
      background: #fff7f7;
      border-radius: 18px;
      padding: 10px 12px 10px;
      box-shadow: 0 10px 24px rgba(185, 28, 28, 0.22);
      border: 1px solid rgba(254, 202, 202, 0.95);
    }

    .recipe-card[open] {
      box-shadow: 0 14px 30px rgba(185, 28, 28, 0.3);
    }

    .recipe-card summary {
      list-style: none;
      cursor: pointer;
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 16px;
    }

    .recipe-card summary::-webkit-details-marker {
      display: none;
    }

    .recipe-summary-main {
      min-width: 0;
    }

    .recipe-title {
      font-weight: 600;
      margin: 0 0 2px;
      font-size: 1rem;
    }

    .recipe-summary-sub {
      font-size: 0.8rem;
      color: #6b7280;
    }

    .time-block {
      background: #fee2e2;
      border-radius: 12px;
      padding: 6px 10px;
      font-size: 0.75rem;
      color: #7f1d1d;
      min-width: 150px;
      border: 1px solid #fecaca;
    }

    .time-line {
      display: flex;
      justify-content: space-between;
      gap: 6px;
      margin-bottom: 2px;
    }

    .time-line:last-child {
      margin-bottom: 0;
    }

    .time-label {
      font-weight: 500;
    }

    .time-value {
      white-space: nowrap;
    }

    .summary-arrow {
      margin-left: 10px;
      font-size: 0.8rem;
      color: #9ca3af;
      align-self: center;
    }

    .recipe-body {
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid #fecaca;
      font-size: 0.8rem;
      color: #374151;
    }

    .tags {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-bottom: 6px;
    }

    .tag {
      font-size: 0.7rem;
      padding: 1px 7px;
      border-radius: 999px;
      background: #f3f4f6;
      color: #4b5563;
    }

    .servings-row {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
    }

    .servings-row span {
      font-size: 0.78rem;
      color: #4b5563;
    }

    .servings-row label {
      font-size: 0.78rem;
      font-weight: 500;
      margin-bottom: 0;
    }

    .recipe-section-title {
      font-size: 0.8rem;
      font-weight: 600;
      margin: 6px 0 2px;
      color: #374151;
    }

    .recipe-ingredients {
      font-size: 0.8rem;
      margin: 0;
      padding-left: 16px;
    }

    .recipe-ingredients li {
      margin-bottom: 1px;
    }

    .recipe-instructions {
      font-size: 0.8rem;
      margin: 0;
      padding-left: 16px;
    }

    .recipe-instructions li {
      margin-bottom: 3px;
    }

    .no-results {
      font-size: 0.9rem;
      color: #6b7280;
      margin-top: 8px;
    }

    footer {
      margin-top: 32px;
      font-size: 0.75rem;
      color: #9ca3af;
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="page">
    <!-- skjult status til JS -->
    <div id="loadStatus" class="status"></div>

    <section class="card">
      <label for="ingredientInput">Tilf√∏j ingrediens</label>

      <div class="input-row">
        <input
          type="text"
          id="ingredientInput"
          placeholder="fx kartofler"
          autocomplete="off"
        />
        <button id="addIngredientButton" type="button">‚ûï Tilf√∏j</button>
        <button id="clearIngredientsButton" type="button" class="button--ghost">
          Nulstil ingredienser
        </button>
      </div>

      <div id="suggestions" class="suggestions"></div>

      <div id="chipsContainer" class="chips"></div>

      <div class="filters-row">
        <label for="minMatches">Mindst antal matchende ingredienser:</label>
        <select id="minMatches">
          <option value="1">1+</option>
          <option value="2">2+</option>
          <option value="3">3+</option>
          <option value="4">4+</option>
        </select>

        <button id="searchButton" type="button">üîç Find opskrifter</button>
        <span class="small" id="ingredientInfo"></span>
      </div>
    </section>

    <section>
      <div class="results-header">
        <h2>Forslag</h2>
        <span class="results-count" id="resultsCount"></span>
      </div>
      <div id="results" class="results"></div>
      <p id="noResults" class="no-results" style="display: none">
        Ingen opskrifter matchede med de nuv√¶rende kriterier. Pr√∏v med f√¶rre
        ingredienser eller lavere antal kr√¶vede matches üôÇ
      </p>
    </section>

    <footer>
      Privat opskriftsv√¶rkt√∏j. Data kommer fra <code>recipes.json</code>.
    </footer>
  </div>

  <script>
    let allRecipes = [];
    let recipesLoaded = false;
    let selectedIngredients = [];
    let ingredientDictionary = new Map(); // normalized -> visningsnavn

    function normalize(text) {
      return text
        .toString()
        .trim()
        .toLowerCase()
        .replace(/\s+/g, " ");
    }

    function buildIngredientDictionary() {
      ingredientDictionary.clear();
      allRecipes.forEach((recipe) => {
        (recipe.ingredientKeywords || []).forEach((kw) => {
          const norm = normalize(kw);
          if (!norm) return;
          if (!ingredientDictionary.has(norm)) {
            ingredientDictionary.set(norm, kw);
          }
        });
      });
    }

    function renderIngredientChips() {
      const container = document.getElementById("chipsContainer");
      const info = document.getElementById("ingredientInfo");
      container.innerHTML = "";

      if (selectedIngredients.length === 0) {
        const hint = document.createElement("span");
        hint.className = "small";
        hint.textContent = "Ingen ingredienser tilf√∏jet endnu.";
        container.appendChild(hint);
        info.textContent = "";
        return;
      }

      selectedIngredients.forEach((norm) => {
        const chip = document.createElement("div");
        chip.className = "chip";

        const label = document.createElement("span");
        const display = ingredientDictionary.get(norm) || norm;
        label.textContent = display;

        const removeBtn = document.createElement("button");
        removeBtn.className = "chip-remove";
        removeBtn.type = "button";
        removeBtn.textContent = "‚úï";
        removeBtn.addEventListener("click", () => {
          selectedIngredients = selectedIngredients.filter((i) => i !== norm);
          renderIngredientChips();
          searchRecipes();
        });

        chip.appendChild(label);
        chip.appendChild(removeBtn);
        container.appendChild(chip);
      });

      info.textContent =
        selectedIngredients.length === 1
          ? "1 ingrediens valgt"
          : selectedIngredients.length + " ingredienser valgt";
    }

    function hideSuggestions() {
      const suggestionsEl = document.getElementById("suggestions");
      suggestionsEl.style.display = "none";
      suggestionsEl.innerHTML = "";
    }

    function addIngredientFromNormalized(norm) {
      if (!norm) return;
      if (selectedIngredients.includes(norm)) return;
      selectedIngredients.push(norm);
      renderIngredientChips();
      searchRecipes();
      hideSuggestions();
    }

    function addIngredient() {
      const input = document.getElementById("ingredientInput");
      const suggestionsEl = document.getElementById("suggestions");
      const firstSuggestion = suggestionsEl.querySelector(".suggestion-item");

      if (firstSuggestion) {
        const norm = firstSuggestion.dataset.norm;
        addIngredientFromNormalized(norm);
        input.value = "";
        return;
      }

      const raw = normalize(input.value);
      if (!raw) return;
      addIngredientFromNormalized(raw);
      input.value = "";
    }

    function clearIngredients() {
      selectedIngredients = [];
      renderIngredientChips();
      renderResults([]);
      hideSuggestions();
    }

    function matchCountForRecipe(recipe, ingredients) {
      const keywords = (recipe.ingredientKeywords || []).map((k) =>
        normalize(k)
      );
      if (!keywords.length) return 0;
      let count = 0;
      ingredients.forEach((userIng) => {
        const matched = keywords.some(
          (kw) => kw.includes(userIng) || userIng.includes(kw)
        );
        if (matched) count++;
      });
      return count;
    }

    function searchRecipes() {
      const resultsContainer = document.getElementById("results");
      const noResultsEl = document.getElementById("noResults");
      const resultsCount = document.getElementById("resultsCount");

      if (!recipesLoaded) {
        resultsContainer.innerHTML = "";
        resultsCount.textContent = "";
        noResultsEl.style.display = "none";
        return;
      }

      if (selectedIngredients.length === 0) {
        resultsContainer.innerHTML = "";
        resultsCount.textContent = "";
        noResultsEl.style.display = "none";
        return;
      }

      const minMatches =
        parseInt(document.getElementById("minMatches").value, 10) || 1;

      const matches = allRecipes
        .map((recipe) => {
          const matchCount = matchCountForRecipe(
            recipe,
            selectedIngredients
          );
          return { recipe, matchCount };
        })
        .filter((entry) => entry.matchCount >= minMatches)
        .sort((a, b) => b.matchCount - a.matchCount);

      const onlyRecipes = matches.map((m) => ({
        ...m.recipe,
        _matchCount: m.matchCount,
      }));

      renderResults(onlyRecipes);
    }

    // Skaler m√¶ngder ved at gange f√∏rste tal i strengen
    function scaleAmount(amount, factor) {
      if (!amount || typeof amount !== "string" || factor === 1) {
        return amount || "";
      }
      const trimmed = amount.trim();
      const match = trimmed.match(/^(\d+(?:[.,]\d+)?)(.*)$/);
      if (!match) return amount;

      const base = parseFloat(match[1].replace(",", "."));
      if (isNaN(base)) return amount;

      const scaled = base * factor;
      const rounded = Math.round((scaled + Number.EPSILON) * 10) / 10;
      const isInt = Math.abs(rounded - Math.round(rounded)) < 0.05;
      const numStr = isInt
        ? Math.round(rounded).toString()
        : rounded.toString().replace(".", ",");

      return numStr + match[2];
    }

    function renderResults(recipes) {
      const resultsContainer = document.getElementById("results");
      const noResultsEl = document.getElementById("noResults");
      const resultsCount = document.getElementById("resultsCount");

      resultsContainer.innerHTML = "";
      noResultsEl.style.display = "none";
      resultsCount.textContent = "";

      if (!recipes || recipes.length === 0) {
        if (selectedIngredients.length > 0) {
          noResultsEl.style.display = "block";
          resultsCount.textContent = "0 resultater";
        }
        return;
      }

      resultsCount.textContent =
        recipes.length === 1
          ? "1 resultat"
          : recipes.length + " resultater";

      recipes.forEach((recipe) => {
        const card = document.createElement("details");
        card.className = "recipe-card";

        const summary = document.createElement("summary");

        const summaryMain = document.createElement("div");
        summaryMain.className = "recipe-summary-main";

        const title = document.createElement("h3");
        title.className = "recipe-title";
        title.textContent = recipe.title || "(uden titel)";
        summaryMain.appendChild(title);

        const subtitle = document.createElement("div");
        subtitle.className = "recipe-summary-sub";
        const servings =
          typeof recipe.servings === "number"
            ? recipe.servings + " pers."
            : recipe.servings || "";
        subtitle.textContent = servings ? "Opskrift til " + servings : "";
        summaryMain.appendChild(subtitle);

        const timeBlock = document.createElement("div");
        timeBlock.className = "time-block";

        const prep = recipe.prepTime || "‚Äì";
        const cook = recipe.cookTime || "‚Äì";
        let total = recipe.time;
        if (
          !total &&
          typeof recipe.prepTimeMinutes === "number" &&
          typeof recipe.cookTimeMinutes === "number"
        ) {
          const totalMin = recipe.prepTimeMinutes + recipe.cookTimeMinutes;
          total = totalMin + " min";
        }
        total = total || "‚Äì";

        function addTimeLine(label, value) {
          const line = document.createElement("div");
          line.className = "time-line";
          const l = document.createElement("span");
          l.className = "time-label";
          l.textContent = label;
          const v = document.createElement("span");
          v.className = "time-value";
          v.textContent = value;
          line.appendChild(l);
          line.appendChild(v);
          timeBlock.appendChild(line);
        }

        addTimeLine("Forberedelse", prep);
        addTimeLine("Tilberedning", cook);
        addTimeLine("I alt", total);

        const arrow = document.createElement("span");
        arrow.className = "summary-arrow";
        arrow.textContent = "‚ñæ";

        summary.appendChild(summaryMain);
        summary.appendChild(timeBlock);
        summary.appendChild(arrow);

        card.appendChild(summary);

        card.addEventListener("toggle", () => {
          arrow.textContent = card.open ? "‚ñ¥" : "‚ñæ";
        });

        const body = document.createElement("div");
        body.className = "recipe-body";

        if ((recipe.tags || []).length > 0) {
          const tagsEl = document.createElement("div");
          tagsEl.className = "tags";
          (recipe.tags || []).forEach((tag) => {
            const span = document.createElement("span");
            span.className = "tag";
            span.textContent = tag;
            tagsEl.appendChild(span);
          });
          body.appendChild(tagsEl);
        }

        const baseServings =
          typeof recipe.servings === "number" ? recipe.servings : 4;
        const baseIngredients = (recipe.ingredients || []).map((ing) => ({
          ...ing,
        }));

        const servingsRow = document.createElement("div");
        servingsRow.className = "servings-row";

        const baseInfo = document.createElement("span");
        baseInfo.textContent =
          "Opskriften er skrevet til " + baseServings + " personer.";
        servingsRow.appendChild(baseInfo);

        const selectLabel = document.createElement("label");
        selectLabel.textContent = "Skal√©r til:";

        const servingsSelect = document.createElement("select");
        const possibleServings = [2, 4, 6, 8, 10];
        if (!possibleServings.includes(baseServings)) {
          possibleServings.unshift(baseServings);
        }
        possibleServings.forEach((val) => {
          const opt = document.createElement("option");
          opt.value = val;
          opt.textContent = val + " pers.";
          if (val === baseServings) opt.selected = true;
          servingsSelect.appendChild(opt);
        });

        selectLabel.appendChild(servingsSelect);
        servingsRow.appendChild(selectLabel);
        body.appendChild(servingsRow);

        const ingredientsTitle = document.createElement("div");
        ingredientsTitle.className = "recipe-section-title";
        ingredientsTitle.textContent = "Ingredienser";
        body.appendChild(ingredientsTitle);

        const ingredientsList = document.createElement("ul");
        ingredientsList.className = "recipe-ingredients";
        body.appendChild(ingredientsList);

        function updateIngredientsList() {
          ingredientsList.innerHTML = "";
          const desiredServings = parseInt(
            servingsSelect.value || baseServings,
            10
          );
          const factor =
            desiredServings && baseServings
              ? desiredServings / baseServings
              : 1;

          baseIngredients.forEach((ing) => {
            const li = document.createElement("li");
            const amountText = scaleAmount(ing.amount || "", factor);
            const amountPart = amountText ? amountText + " " : "";
            li.textContent = amountPart + ing.name;
            ingredientsList.appendChild(li);
          });
        }

        servingsSelect.addEventListener("change", updateIngredientsList);
        updateIngredientsList();

        const instructionsTitle = document.createElement("div");
        instructionsTitle.className = "recipe-section-title";
        instructionsTitle.textContent = "Fremgangsm√•de";
        body.appendChild(instructionsTitle);

        const instructionsList = document.createElement("ol");
        instructionsList.className = "recipe-instructions";
        (recipe.instructions || []).forEach((step) => {
          const li = document.createElement("li");
          li.textContent = step;
          instructionsList.appendChild(li);
        });
        body.appendChild(instructionsList);

        if (recipe.notes) {
          const notesTitle = document.createElement("div");
          notesTitle.className = "recipe-section-title";
          notesTitle.textContent = "Noter";
          const notesP = document.createElement("p");
          notesP.className = "small";
          notesP.textContent = recipe.notes;
          body.appendChild(notesTitle);
          body.appendChild(notesP);
        }

        card.appendChild(body);
        resultsContainer.appendChild(card);
      });
    }

    // Autocomplete-s√∏gning i ingrediens-ordbog
    function updateSuggestions() {
      const input = document.getElementById("ingredientInput");
      const suggestionsEl = document.getElementById("suggestions");

      const term = normalize(input.value);
      suggestionsEl.innerHTML = "";

      if (!recipesLoaded || term.length < 2) {
        suggestionsEl.style.display = "none";
        return;
      }

      const matches = [];
      for (const [norm, original] of ingredientDictionary.entries()) {
        if (norm.startsWith(term)) {
          matches.push({ norm, original });
          if (matches.length >= 8) break;
        }
      }

      if (matches.length === 0) {
        suggestionsEl.style.display = "none";
        return;
      }

      matches.forEach((m) => {
        const item = document.createElement("div");
        item.className = "suggestion-item";
        item.textContent = m.original;
        item.dataset.norm = m.norm;
        item.addEventListener("mousedown", (e) => {
          e.preventDefault();
          addIngredientFromNormalized(m.norm);
          document.getElementById("ingredientInput").value = "";
        });
        suggestionsEl.appendChild(item);
      });

      suggestionsEl.style.display = "block";
    }

    // Indl√¶s recipes.json
    (function loadRecipes() {
      const statusEl = document.getElementById("loadStatus");
      fetch("recipes.json")
        .then((res) => {
          if (!res.ok) {
            throw new Error(
              "Kunne ikke hente recipes.json (status " + res.status + ")"
            );
          }
          return res.json();
        })
        .then((data) => {
          if (!Array.isArray(data)) {
            throw new Error("recipes.json skal v√¶re et JSON-array []");
          }
          allRecipes = data;
          recipesLoaded = true;
          buildIngredientDictionary();
          statusEl.textContent =
            "Indl√¶ste " +
            allRecipes.length +
            (allRecipes.length === 1
              ? " opskrift."
              : " opskrifter.");
        })
        .catch((err) => {
          console.error(err);
          recipesLoaded = false;
          statusEl.textContent =
            "Fejl ved indl√¶sning af recipes.json: " + err.message;
        });
    })();

    // Event listeners
    document
      .getElementById("addIngredientButton")
      .addEventListener("click", addIngredient);

    document
      .getElementById("ingredientInput")
      .addEventListener("keydown", function (event) {
        if (event.key === "Enter") {
          event.preventDefault();
          addIngredient();
        }
      });

    document
      .getElementById("ingredientInput")
      .addEventListener("input", updateSuggestions);

    document
      .getElementById("clearIngredientsButton")
      .addEventListener("click", clearIngredients);

    document
      .getElementById("searchButton")
      .addEventListener("click", searchRecipes);

    document
      .getElementById("minMatches")
      .addEventListener("change", searchRecipes);

    // Luk forslag n√•r man klikker udenfor
    document.addEventListener("click", (e) => {
      const s = document.getElementById("suggestions");
      const input = document.getElementById("ingredientInput");
      if (!s.contains(e.target) && e.target !== input) {
        hideSuggestions();
      }
    });

    // F√∏rste render
    renderIngredientChips();
  </script>
</body>
</html>
