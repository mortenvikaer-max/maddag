<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Opskriftsv√¶rkt√∏j</title>
  <style>
    :root {
      --red-main: #c8102e;      /* Politiken-agtig r√∏d */
      --red-dark: #8f071f;
      --red-soft: #fbeaec;      /* lys r√∏dlig, men ikke pastel-lyser√∏d */
      --bg-main: #f3f4f6;       /* lys gr√• baggrund */
      --ink: #111827;

      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      line-height: 1.5;
      color: var(--ink);
    }

    body {
      margin: 0;
      padding: 0;
      background: var(--bg-main);
      color: var(--ink);
    }

    /* Dekorative bobler i baggrunden */
    .bg-bubbles {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 0;
      overflow: hidden;
    }

    .bubble {
      position: absolute;
      border-radius: 50%;
      mix-blend-mode: multiply;
      filter: blur(1px);
    }

    .bubble--1 {
      width: 460px;
      height: 460px;
      top: -140px;
      left: -160px;
      background: radial-gradient(circle at center,
        rgba(200, 16, 46, 0.8),
        rgba(200, 16, 46, 0));
      opacity: 0.8;
    }

    .bubble--2 {
      width: 420px;
      height: 420px;
      bottom: -160px;
      right: -160px;
      background: radial-gradient(circle at center,
        rgba(15, 23, 42, 0.8),
        rgba(15, 23, 42, 0));
      opacity: 0.8;
    }

    .bubble--3 {
      width: 280px;
      height: 280px;
      top: 12%;
      left: -70px;
      background: radial-gradient(circle at center,
        rgba(30, 64, 175, 0.7),
        rgba(30, 64, 175, 0));
      opacity: 0.65;
    }

    .bubble--4 {
      width: 260px;
      height: 260px;
      top: 60%;
      left: -40px;
      background: radial-gradient(circle at center,
        rgba(148, 163, 184, 0.7),
        rgba(148, 163, 184, 0));
      opacity: 0.6;
    }

    .bubble--5 {
      width: 280px;
      height: 280px;
      top: 8%;
      right: -60px;
      background: radial-gradient(circle at center,
        rgba(200, 16, 46, 0.7),
        rgba(200, 16, 46, 0));
      opacity: 0.65;
    }

    .bubble--6 {
      width: 260px;
      height: 260px;
      bottom: 20%;
      right: 2%;
      background: radial-gradient(circle at center,
        rgba(31, 41, 55, 0.7),
        rgba(31, 41, 55, 0));
      opacity: 0.6;
    }

    .bubble--7 {
      width: 170px;
      height: 170px;
      top: 30%;
      right: 30%;
      background: radial-gradient(circle at center,
        rgba(148, 163, 184, 0.6),
        rgba(148, 163, 184, 0));
      opacity: 0.5;
    }

    .bubble--8 {
      width: 150px;
      height: 150px;
      bottom: 32%;
      left: 34%;
      background: radial-gradient(circle at center,
        rgba(30, 64, 175, 0.7),
        rgba(30, 64, 175, 0));
      opacity: 0.55;
    }

    .bubble--9 {
      width: 120px;
      height: 120px;
      top: 9%;
      left: 44%;
      background: radial-gradient(circle at center,
        rgba(15, 23, 42, 0.7),
        rgba(15, 23, 42, 0));
      opacity: 0.4;
    }

    .bubble--10 {
      width: 130px;
      height: 130px;
      bottom: 10%;
      right: 44%;
      background: radial-gradient(circle at center,
        rgba(200, 16, 46, 0.7),
        rgba(200, 16, 46, 0));
      opacity: 0.45;
    }

    .bubble--11 {
      width: 110px;
      height: 110px;
      top: 52%;
      right: 10%;
      background: radial-gradient(circle at center,
        rgba(148, 163, 184, 0.9),
        rgba(148, 163, 184, 0));
      opacity: 0.35;
    }

    .bubble--12 {
      width: 90px;
      height: 90px;
      top: 22%;
      left: 16%;
      background: radial-gradient(circle at center,
        rgba(15, 23, 42, 0.8),
        rgba(15, 23, 42, 0));
      opacity: 0.5;
    }

    .bubble--13 {
      width: 120px;
      height: 120px;
      top: 40%;
      left: 28%;
      background: radial-gradient(circle at center,
        rgba(200, 16, 46, 0.4),
        rgba(200, 16, 46, 0));
      opacity: 0.25;
    }

    .bubble--14 {
      width: 100px;
      height: 100px;
      bottom: 18%;
      left: 18%;
      background: radial-gradient(circle at center,
        rgba(30, 64, 175, 0.4),
        rgba(30, 64, 175, 0));
      opacity: 0.2;
    }

    .bubble--15 {
      width: 140px;
      height: 140px;
      top: 70%;
      right: 26%;
      background: radial-gradient(circle at center,
        rgba(148, 163, 184, 0.4),
        rgba(148, 163, 184, 0));
      opacity: 0.2;
    }

    .bubble--16 {
      width: 90px;
      height: 90px;
      top: 5%;
      right: 22%;
      background: radial-gradient(circle at center,
        rgba(15, 23, 42, 0.35),
        rgba(15, 23, 42, 0));
      opacity: 0.18;
    }

    .bubble--17 {
      width: 80px;
      height: 80px;
      bottom: 6%;
      left: 50%;
      background: radial-gradient(circle at center,
        rgba(200, 16, 46, 0.3),
        rgba(200, 16, 46, 0));
      opacity: 0.18;
    }

    .bubble--18 {
      width: 150px;
      height: 150px;
      top: 45%;
      right: 50%;
      background: radial-gradient(circle at center,
        rgba(148, 163, 184, 0.25),
        rgba(148, 163, 184, 0));
      opacity: 0.12;
    }

    .bubble--19 {
      width: 130px;
      height: 130px;
      top: 35%;
      right: 5%;
      background: radial-gradient(circle at center,
        rgba(30, 64, 175, 0.25),
        rgba(30, 64, 175, 0));
      opacity: 0.1;
    }

    .bubble--20 {
      width: 160px;
      height: 160px;
      bottom: 40%;
      left: 52%;
      background: radial-gradient(circle at center,
        rgba(15, 23, 42, 0.2),
        rgba(15, 23, 42, 0));
      opacity: 0.08;
    }

    @media (max-width: 768px) {
      .bubble {
        opacity: 0.2 !important;
        filter: blur(0.5px);
      }
      .bubble--1,
      .bubble--2 {
        display: none;
      }
    }

    .page {
      position: relative;
      z-index: 1;
      max-width: 1000px;
      margin: 0 auto;
      padding: 24px 16px 48px;
    }

    .status {
      display: none;
    }

    .card {
      background: #ffffff;
      backdrop-filter: blur(8px);
      border-radius: 18px;
      padding: 16px 16px 20px;
      box-shadow: 0 14px 30px rgba(15, 23, 42, 0.25);
      margin-bottom: 24px;
      border-left: 4px solid var(--red-main);
      border-top: 1px solid rgba(15, 23, 42, 0.08);
      border-right: 1px solid rgba(15, 23, 42, 0.08);
      border-bottom: 1px solid rgba(15, 23, 42, 0.08);
    }

    label {
      display: block;
      font-weight: 600;
      margin-bottom: 6px;
      letter-spacing: 0.01em;
      text-transform: uppercase;
      font-size: 0.8rem;
      color: #374151;
    }

    .input-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 6px;
    }

    input[type="text"] {
      flex: 1 1 200px;
      padding: 10px 12px;
      font-size: 0.95rem;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: #ffffff;
      box-sizing: border-box;
    }

    input[type="text"]:focus {
      outline: none;
      border-color: var(--red-main);
      box-shadow: 0 0 0 2px rgba(200, 16, 46, 0.35);
      background: #ffffff;
    }

    button {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 9px 16px;
      font-size: 0.9rem;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      cursor: pointer;
      background: #ffffff;
      color: var(--ink);
      white-space: nowrap;
      transition: transform 0.05s ease-out, box-shadow 0.05s ease-out,
        background 0.12s ease-in, border-color 0.12s ease-in;
      box-shadow: 0 3px 10px rgba(15, 23, 42, 0.12);
    }

    button:hover {
      background: #f3f4f6;
      border-color: #9ca3af;
      transform: translateY(-1px);
      box-shadow: 0 6px 16px rgba(15, 23, 42, 0.18);
    }

    button:active {
      transform: translateY(0);
      box-shadow: 0 2px 8px rgba(15, 23, 42, 0.16);
    }

    .button--ghost {
      background: #f3f4f6;
      color: #374151;
      box-shadow: none;
      border: 1px solid #d1d5db;
    }

    .button--ghost:hover {
      background: #e5e7eb;
      box-shadow: none;
    }

    .chips {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 8px;
      min-height: 24px;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      background: var(--red-soft);
      font-size: 0.8rem;
      color: var(--red-dark);
      border: 1px solid var(--red-main);
    }

    .chip span {
      text-transform: lowercase;
    }

    .chip-remove {
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 0.85rem;
      line-height: 1;
      padding: 0;
      color: var(--red-dark);
    }

    .filters-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin-top: 6px;
    }

    .filters-row label.inline {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-weight: 400;
      font-size: 0.78rem;
      color: #4b5563;
      margin-bottom: 0;
      text-transform: none;
    }

    .filters-row input[type="checkbox"] {
      accent-color: var(--red-main);
      cursor: pointer;
    }

    .small {
      font-size: 0.78rem;
      color: #6b7280;
    }

    .suggestions {
      margin-top: 2px;
      margin-bottom: 6px;
      max-width: 260px;
      background: #ffffff;
      border-radius: 12px;
      border: 1px solid #9ca3af;
      box-shadow: 0 8px 18px rgba(15, 23, 42, 0.25);
      display: none;
      overflow: hidden;
      font-size: 0.8rem;
    }

    .suggestion-item {
      padding: 6px 10px;
      cursor: pointer;
      color: var(--red-dark);
    }

    .suggestion-item:hover {
      background: var(--red-soft);
    }

    .results-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 10px;
      gap: 8px;
      flex-wrap: wrap;
    }

    .results-header h2 {
      margin: 0;
      font-size: 1.1rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #111827;
    }

    .results-tools {
      display: inline-flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 8px;
      font-size: 0.8rem;
      color: #4b5563;
    }

    .results-tools label {
      margin-bottom: 0;
      text-transform: none;
      font-size: 0.8rem;
      font-weight: 500;
      letter-spacing: 0;
    }

    .results-tools select {
      padding: 4px 8px;
      font-size: 0.8rem;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: #ffffff;
      color: #111827;
    }

    .results-count {
      font-size: 0.8rem;
      color: #6b7280;
    }

    .results {
      display: grid;
      grid-template-columns: minmax(0, 1fr);
      gap: 14px;
    }

    .recipe-card {
      background: #ffffff;
      border-radius: 18px;
      padding: 10px 12px 10px;
      box-shadow: 0 10px 24px rgba(15, 23, 42, 0.25);
      border-left: 4px solid var(--red-main);
      border-top: 1px solid rgba(15, 23, 42, 0.06);
      border-right: 1px solid rgba(15, 23, 42, 0.06);
      border-bottom: 1px solid rgba(15, 23, 42, 0.06);
    }

    .recipe-card[open] {
      box-shadow: 0 16px 36px rgba(15, 23, 42, 0.3);
    }

    .recipe-card summary {
      list-style: none;
      cursor: pointer;
      display: grid;
      grid-template-columns: minmax(0, 1fr) 170px auto;
      column-gap: 16px;
      align-items: flex-start;
    }

    @media (max-width: 640px) {
      .recipe-card summary {
        grid-template-columns: minmax(0, 1fr);
        row-gap: 8px;
      }
    }

    .recipe-card summary::-webkit-details-marker {
      display: none;
    }

    .recipe-summary-main {
      min-width: 0;
    }

    .recipe-title {
      font-weight: 700;
      margin: 0 0 2px;
      font-size: 1rem;
    }

    .recipe-summary-sub {
      font-size: 0.8rem;
      color: #6b7280;
    }

    .time-block {
      background: var(--red-soft);
      border-radius: 12px;
      padding: 6px 10px;
      font-size: 0.75rem;
      color: var(--red-dark);
      width: 170px;
      border: 1px solid var(--red-main);
    }

    .time-line {
      display: flex;
      justify-content: space-between;
      gap: 6px;
      margin-bottom: 2px;
    }

    .time-line:last-child {
      margin-bottom: 0;
    }

    .time-label {
      font-weight: 600;
    }

    .time-value {
      white-space: nowrap;
    }

    .summary-arrow {
      margin-left: 4px;
      font-size: 0.8rem;
      color: #6b7280;
      align-self: center;
    }

    .recipe-body {
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid #e5e7eb;
      font-size: 0.8rem;
      color: #111827;
    }

    .tags {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-bottom: 6px;
    }

    .tag {
      font-size: 0.7rem;
      padding: 1px 7px;
      border-radius: 999px;
      background: #e5e7eb;
      color: #374151;
    }

    .servings-row {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 4px;
      margin-bottom: 6px;
    }

    .servings-row span {
      font-size: 0.78rem;
      color: #4b5563;
    }

    .servings-scale-row {
      display: inline-flex;
      align-items: center;
      gap: 10px;
    }

    .servings-scale-row label {
      font-size: 0.8rem;
      font-weight: 600;
      margin: 0;
      text-transform: none;
      letter-spacing: 0;
    }

    .servings-scale-row select {
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: #ffffff;
      font-size: 0.8rem;
      color: #111827;
    }

    .recipe-section-title {
      font-size: 0.8rem;
      font-weight: 700;
      margin: 6px 0 2px;
      color: #111827;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    .recipe-columns {
      display: grid;
      grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
      gap: 16px;
      align-items: flex-start;
      margin-top: 4px;
    }

    @media (max-width: 800px) {
      .recipe-columns {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .recipe-ingredients,
    .recipe-instructions {
      font-size: 0.8rem;
      margin: 0;
      padding-left: 16px;
    }

    .recipe-ingredients li,
    .recipe-instructions li {
      margin-bottom: 3px;
    }

    .no-results {
      font-size: 0.9rem;
      color: #6b7280;
      margin-top: 8px;
    }
  </style>
</head>
<body>
  <div class="bg-bubbles">
    <div class="bubble bubble--1"></div>
    <div class="bubble bubble--2"></div>
    <div class="bubble bubble--3"></div>
    <div class="bubble bubble--4"></div>
    <div class="bubble bubble--5"></div>
    <div class="bubble bubble--6"></div>
    <div class="bubble bubble--7"></div>
    <div class="bubble bubble--8"></div>
    <div class="bubble bubble--9"></div>
    <div class="bubble bubble--10"></div>
    <div class="bubble bubble--11"></div>
    <div class="bubble bubble--12"></div>
    <div class="bubble bubble--13"></div>
    <div class="bubble bubble--14"></div>
    <div class="bubble bubble--15"></div>
    <div class="bubble bubble--16"></div>
    <div class="bubble bubble--17"></div>
    <div class="bubble bubble--18"></div>
    <div class="bubble bubble--19"></div>
    <div class="bubble bubble--20"></div>
  </div>

  <div class="page">
    <div id="loadStatus" class="status"></div>

    <section class="card">
      <label for="ingredientInput">Tilf√∏j ingrediens</label>

      <div class="input-row">
        <input
          type="text"
          id="ingredientInput"
          placeholder="fx kartofler"
          autocomplete="off"
        />
        <button id="addIngredientButton" type="button">‚ûï Tilf√∏j</button>
        <button id="clearIngredientsButton" type="button" class="button--ghost">
          Nulstil ingredienser
        </button>
      </div>

      <div id="suggestions" class="suggestions"></div>

      <div id="chipsContainer" class="chips"></div>

      <div class="filters-row">
        <label class="inline">
          <input type="checkbox" id="allowOneMissing" />
          Tillad 1 manglende ingrediens
        </label>

        <span class="small" id="ingredientInfo"></span>
      </div>
    </section>

    <section>
      <div class="results-header">
        <h2>Forslag</h2>
        <div class="results-tools">
          <label for="typeFilter">Type:</label>
          <select id="typeFilter">
            <option value="">Alle</option>
          </select>
          <label for="sortOrder">Sort√©r:</label>
          <select id="sortOrder">
            <option value="match">Bedste match</option>
            <option value="time-asc">Kortest tid</option>
            <option value="time-desc">L√¶ngst tid</option>
          </select>
          <span class="results-count" id="resultsCount"></span>
        </div>
      </div>
      <div id="results" class="results"></div>
      <p id="noResults" class="no-results" style="display: none">
        Ingen opskrifter matchede med de nuv√¶rende ingredienser üôÇ</p>
    </section>
  </div>

  <script>
    let allRecipes = [];
    let recipesLoaded = false;
    let selectedIngredients = [];
    let ingredientDictionary = new Map(); // normalized -> visningsnavn
    let allTagsSet = new Set();

    const normalize = (text) =>
      text
        .toString()
        .trim()
        .toLowerCase()
        .replace(/\s+/g, " ");

    const aliasGroups = [
      ["kylling", "kyllingebryst", "kyllingeinderfilet", "kyllingel√•r", "kyllingel√•r og overl√•r", "kyllingek√∏d", "kyllingefars"],
      ["karry", "karrypulver", "karrypasta"],
      ["oksek√∏d", "hakket oksek√∏d", "oksebov", "okseklump", "okseskank", "oksesteg", "oksegryde"],
      ["svinek√∏d", "hakket svinek√∏d", "svinek√¶ber", "svinesteg", "svinefilet", "svinekoteletter"],
      ["fisk", "laks", "torsk", "hvid fisk", "fiskefars", "fiskefrikadeller"],
      ["b√¶lgfrugter", "kik√¶rter", "linser", "kidneyb√∏nner", "sorte b√∏nner", "hvide b√∏nner"]
    ];

    const expansionMap = {};
    aliasGroups.forEach(group => {
      const ng = group.map(normalize);
      ng.forEach(term => {
        expansionMap[term] = ng;
      });
    });

    function getIngredientVariants(term) {
      const t = normalize(term);
      return expansionMap[t] || [t];
    }

    function addTokensFromString(str, set) {
      const norm = normalize(str || "");
      if (!norm) return;
      set.add(norm); // hele strengen (fx "karrypasta")
      norm.split(/[^a-z√¶√∏√•0-9]+/g)
        .filter(Boolean)
        .forEach(t => set.add(t));
    }

    function buildIngredientDictionary() {
      ingredientDictionary.clear();
      allRecipes.forEach((recipe) => {
        (recipe.ingredientKeywords || []).forEach((kw) => {
          let display = kw.replace(/s√∏dkartoffel/gi, "s√∏d kartoffel");
          const norm = normalize(kw);
          if (!norm) return;
          if (!ingredientDictionary.has(norm)) {
            ingredientDictionary.set(norm, display);
          }
        });
      });
    }

    function renderIngredientChips() {
      const container = document.getElementById("chipsContainer");
      const info = document.getElementById("ingredientInfo");
      container.innerHTML = "";

      if (selectedIngredients.length === 0) {
        const hint = document.createElement("span");
        hint.className = "small";
        hint.textContent = "Ingen ingredienser tilf√∏jet endnu.";
        container.appendChild(hint);
        info.textContent = "";
        return;
      }

      selectedIngredients.forEach((norm) => {
        const chip = document.createElement("div");
        chip.className = "chip";

        const label = document.createElement("span");
        const display = (ingredientDictionary.get(norm) || norm)
          .replace(/s√∏dkartoffel/gi, "s√∏d kartoffel");
        label.textContent = display;

        const removeBtn = document.createElement("button");
        removeBtn.className = "chip-remove";
        removeBtn.type = "button";
        removeBtn.textContent = "‚úï";
        removeBtn.addEventListener("click", () => {
          selectedIngredients = selectedIngredients.filter((i) => i !== norm);
          renderIngredientChips();
          searchRecipes();
        });

        chip.appendChild(label);
        chip.appendChild(removeBtn);
        container.appendChild(chip);
      });

      info.textContent =
        selectedIngredients.length === 1
          ? "1 ingrediens valgt"
          : selectedIngredients.length + " ingredienser valgt";
    }

    function hideSuggestions() {
      const suggestionsEl = document.getElementById("suggestions");
      suggestionsEl.style.display = "none";
      suggestionsEl.innerHTML = "";
    }

    function addIngredientFromNormalized(norm) {
      if (!norm) return;
      if (selectedIngredients.includes(norm)) return;
      selectedIngredients.push(norm);
      renderIngredientChips();
      searchRecipes();
      hideSuggestions();
    }

    function addIngredient() {
      const input = document.getElementById("ingredientInput");
      const suggestionsEl = document.getElementById("suggestions");
      const firstSuggestion = suggestionsEl.querySelector(".suggestion-item");

      if (firstSuggestion) {
        const norm = firstSuggestion.dataset.norm;
        addIngredientFromNormalized(norm);
        input.value = "";
        return;
      }

      const raw = normalize(input.value);
      if (!raw) return;
      addIngredientFromNormalized(raw);
      input.value = "";
    }

    function clearIngredients() {
      selectedIngredients = [];
      renderIngredientChips();
      renderResults([]);
      hideSuggestions();
    }

    function matchCountForRecipe(recipe, ingredients) {
      const tokens = recipe._tokens || [];
      const total = ingredients.length;
      if (total === 0) return 0;

      let matches = 0;
      ingredients.forEach((ing) => {
        const variants = getIngredientVariants(ing);
        const found = variants.some((v) => tokens.includes(v));
        if (found) matches++;
      });
      return matches;
    }

    function getTotalMinutes(recipe) {
      if (typeof recipe.timeMinutes === "number") return recipe.timeMinutes;
      const prep =
        typeof recipe.prepTimeMinutes === "number"
          ? recipe.prepTimeMinutes
          : null;
      const cook =
        typeof recipe.cookTimeMinutes === "number"
          ? recipe.cookTimeMinutes
          : null;
      if (prep != null && cook != null) return prep + cook;
      return Number.POSITIVE_INFINITY;
    }

    function searchRecipes() {
      const resultsContainer = document.getElementById("results");
      const noResultsEl = document.getElementById("noResults");
      const resultsCount = document.getElementById("resultsCount");
      const sortOrder =
        document.getElementById("sortOrder").value || "match";
      const typeFilter =
        (document.getElementById("typeFilter").value || "").toLowerCase();

      if (!recipesLoaded) {
        resultsContainer.innerHTML = "";
        resultsCount.textContent = "";
        noResultsEl.style.display = "none";
        return;
      }

      if (selectedIngredients.length === 0) {
        resultsContainer.innerHTML = "";
        resultsCount.textContent = "";
        noResultsEl.style.display = "none";
        return;
      }

      const allowOneMissing =
        document.getElementById("allowOneMissing").checked;

      const totalSelected = selectedIngredients.length;
      const requiredMatches = allowOneMissing
        ? Math.max(totalSelected - 1, 1)
        : totalSelected;

      let matches = allRecipes
        .map((recipe) => {
          const matchCount = matchCountForRecipe(recipe, selectedIngredients);
          const totalMinutes = getTotalMinutes(recipe);
          return { recipe, matchCount, totalMinutes };
        })
        .filter((entry) => entry.matchCount >= requiredMatches)
        .filter((entry) => {
          if (!typeFilter) return true;
          const tags = (entry.recipe.tags || []).map((t) =>
            t.toLowerCase()
          );
          return tags.includes(typeFilter);
        });

      matches.sort((a, b) => {
        if (sortOrder === "time-asc") {
          return (
            a.totalMinutes - b.totalMinutes || b.matchCount - a.matchCount
          );
        } else if (sortOrder === "time-desc") {
          return (
            b.totalMinutes - a.totalMinutes || b.matchCount - a.matchCount
          );
        } else {
          return (
            b.matchCount - a.matchCount || a.totalMinutes - b.totalMinutes
          );
        }
      });

      const onlyRecipes = matches.map((m) => ({
        ...m.recipe,
        _matchCount: m.matchCount,
        _totalMinutes: m.totalMinutes,
      }));

      renderResults(onlyRecipes);
    }

    function scaleAmount(amount, factor) {
      if (!amount || typeof amount !== "string" || factor === 1) {
        return amount || "";
      }
      const trimmed = amount.trim();
      const match = trimmed.match(/^(\d+(?:[.,]\d+)?)(.*)$/);
      if (!match) return amount;

      const base = parseFloat(match[1].replace(",", "."));
      if (isNaN(base)) return amount;

      const scaled = base * factor;
      const rounded = Math.round((scaled + Number.EPSILON) * 10) / 10;
      const isInt = Math.abs(rounded - Math.round(rounded)) < 0.05;
      const numStr = isInt
        ? Math.round(rounded).toString()
        : rounded.toString().replace(".", ",");

      return numStr + match[2];
    }

    function renderResults(recipes) {
      const resultsContainer = document.getElementById("results");
      const noResultsEl = document.getElementById("noResults");
      const resultsCount = document.getElementById("resultsCount");

      resultsContainer.innerHTML = "";
      noResultsEl.style.display = "none";
      resultsCount.textContent = "";

      if (!recipes || recipes.length === 0) {
        if (selectedIngredients.length > 0) {
          noResultsEl.style.display = "block";
          resultsCount.textContent = "0 resultater";
        }
        return;
      }

      resultsCount.textContent =
        recipes.length === 1
          ? "1 resultat"
          : recipes.length + " resultater";

      recipes.forEach((recipe) => {
        const card = document.createElement("details");
        card.className = "recipe-card";

        const summary = document.createElement("summary");

        const summaryMain = document.createElement("div");
        summaryMain.className = "recipe-summary-main";

        const title = document.createElement("h3");
        title.className = "recipe-title";
        title.textContent = recipe.title || "(uden titel)";
        summaryMain.appendChild(title);

        const subtitle = document.createElement("div");
        subtitle.className = "recipe-summary-sub";
        const servings =
          typeof recipe.servings === "number"
            ? recipe.servings + " pers."
            : recipe.servings || "";
        subtitle.textContent = servings ? "Opskrift til " + servings : "";
        summaryMain.appendChild(subtitle);

        const timeBlock = document.createElement("div");
        timeBlock.className = "time-block";

        const prep = recipe.prepTime || "‚Äì";
        const cook = recipe.cookTime || "‚Äì";
        let total = recipe.time;
        if (
          !total &&
          typeof recipe.prepTimeMinutes === "number" &&
          typeof recipe.cookTimeMinutes === "number"
        ) {
          const totalMin = recipe.prepTimeMinutes + recipe.cookTimeMinutes;
          total = totalMin + " min";
        }
        total = total || "‚Äì";

        function addTimeLine(label, value) {
          const line = document.createElement("div");
          line.className = "time-line";
          const l = document.createElement("span");
          l.className = "time-label";
          l.textContent = label;
          const v = document.createElement("span");
          v.className = "time-value";
          v.textContent = value;
          line.appendChild(l);
          line.appendChild(v);
          timeBlock.appendChild(line);
        }

        addTimeLine("Forberedelse", prep);
        addTimeLine("Tilberedning", cook);
        addTimeLine("I alt", total);

        const arrow = document.createElement("span");
        arrow.className = "summary-arrow";
        arrow.textContent = "‚ñæ";

        summary.appendChild(summaryMain);
        summary.appendChild(timeBlock);
        summary.appendChild(arrow);

        card.appendChild(summary);

        card.addEventListener("toggle", () => {
          arrow.textContent = card.open ? "‚ñ¥" : "‚ñæ";
        });

        const body = document.createElement("div");
        body.className = "recipe-body";

        if ((recipe.tags || []).length > 0) {
          const tagsEl = document.createElement("div");
          tagsEl.className = "tags";
          (recipe.tags || []).forEach((tag) => {
            const span = document.createElement("span");
            span.className = "tag";
            span.textContent = tag;
            tagsEl.appendChild(span);
          });
          body.appendChild(tagsEl);
        }

        const baseServings =
          typeof recipe.servings === "number" ? recipe.servings : 4;
        const baseIngredients = (recipe.ingredients || []).map((ing) => ({
          ...ing,
        }));

        const servingsRow = document.createElement("div");
        servingsRow.className = "servings-row";

        const baseInfo = document.createElement("span");
        baseInfo.textContent =
          "Opskriften er skrevet til " + baseServings + " personer.";
        servingsRow.appendChild(baseInfo);

        const scaleRow = document.createElement("div");
        scaleRow.className = "servings-scale-row";

        const selectLabel = document.createElement("label");
        selectLabel.textContent = "Skal√©r til";

        const servingsSelect = document.createElement("select");
        const possibleServings = [2, 4, 6, 8, 10];
        if (!possibleServings.includes(baseServings)) {
          possibleServings.unshift(baseServings);
        }
        possibleServings.forEach((val) => {
          const opt = document.createElement("option");
          opt.value = val;
          opt.textContent = val + " pers.";
          if (val === baseServings) opt.selected = true;
          servingsSelect.appendChild(opt);
        });

        scaleRow.appendChild(selectLabel);
        scaleRow.appendChild(servingsSelect);
        servingsRow.appendChild(scaleRow);
        body.appendChild(servingsRow);

        const columns = document.createElement("div");
        columns.className = "recipe-columns";

        const leftCol = document.createElement("div");
        const rightCol = document.createElement("div");

        const ingredientsTitle = document.createElement("div");
        ingredientsTitle.className = "recipe-section-title";
        ingredientsTitle.textContent = "Ingredienser";
        leftCol.appendChild(ingredientsTitle);

        const ingredientsList = document.createElement("ul");
        ingredientsList.className = "recipe-ingredients";
        leftCol.appendChild(ingredientsList);

        function updateIngredientsList() {
          ingredientsList.innerHTML = "";
          const desiredServings = parseInt(
            servingsSelect.value || baseServings,
            10
          );
          const factor =
            desiredServings && baseServings
              ? desiredServings / baseServings
              : 1;

          baseIngredients.forEach((ing) => {
            const li = document.createElement("li");
            const amountText = scaleAmount(ing.amount || "", factor);
            const amountPart = amountText ? amountText + " " : "";
            const nameFixed = (ing.name || "").replace(
              /s√∏dkartoffel/gi,
              "s√∏d kartoffel"
            );
            li.textContent = amountPart + nameFixed;
            ingredientsList.appendChild(li);
          });
        }

        servingsSelect.addEventListener("change", updateIngredientsList);
        updateIngredientsList();

        const instructionsTitle = document.createElement("div");
        instructionsTitle.className = "recipe-section-title";
        instructionsTitle.textContent = "Fremgangsm√•de";
        rightCol.appendChild(instructionsTitle);

        const instructionsList = document.createElement("ol");
        instructionsList.className = "recipe-instructions";
        (recipe.instructions || []).forEach((step) => {
          const li = document.createElement("li");
          li.textContent = step;
          instructionsList.appendChild(li);
        });
        rightCol.appendChild(instructionsList);

        columns.appendChild(leftCol);
        columns.appendChild(rightCol);
        body.appendChild(columns);

        if (recipe.notes) {
          const notesTitle = document.createElement("div");
          notesTitle.className = "recipe-section-title";
          notesTitle.textContent = "Noter";
          const notesP = document.createElement("p");
          notesP.className = "small";
          notesP.textContent = recipe.notes;
          body.appendChild(notesTitle);
          body.appendChild(notesP);
        }

        card.appendChild(body);
        resultsContainer.appendChild(card);
      });
    }

    function updateSuggestions() {
      const input = document.getElementById("ingredientInput");
      const suggestionsEl = document.getElementById("suggestions");

      const term = normalize(input.value);
      suggestionsEl.innerHTML = "";

      if (!recipesLoaded || term.length < 2) {
        suggestionsEl.style.display = "none";
        return;
      }

      const matches = [];
      for (const [norm, original] of ingredientDictionary.entries()) {
        if (norm.startsWith(term)) {
          matches.push({ norm, original });
          if (matches.length >= 8) break;
        }
      }

      if (matches.length === 0) {
        suggestionsEl.style.display = "none";
        return;
      }

      matches.forEach((m) => {
        const item = document.createElement("div");
        item.className = "suggestion-item";
        item.textContent = m.original.replace(/s√∏dkartoffel/gi, "s√∏d kartoffel");
        item.dataset.norm = m.norm;
        item.addEventListener("mousedown", (e) => {
          e.preventDefault();
          addIngredientFromNormalized(m.norm);
          document.getElementById("ingredientInput").value = "";
        });
        suggestionsEl.appendChild(item);
      });

      suggestionsEl.style.display = "block";
    }

    (function loadRecipes() {
      const statusEl = document.getElementById("loadStatus");
      fetch("recipes.json")
        .then((res) => {
          if (!res.ok) {
            throw new Error(
              "Kunne ikke hente recipes.json (status " + res.status + ")"
            );
          }
          return res.json();
        })
        .then((data) => {
          if (!Array.isArray(data)) {
            throw new Error("recipes.json skal v√¶re et JSON-array []");
          }

          allRecipes = data.map((r) => {
            const tokenSet = new Set();
            (r.ingredientKeywords || []).forEach((kw) =>
              addTokensFromString(kw, tokenSet)
            );
            (r.ingredients || []).forEach((ing) =>
              addTokensFromString(ing.name, tokenSet)
            );
            (r.tags || []).forEach((tag) => allTagsSet.add(tag));
            return { ...r, _tokens: Array.from(tokenSet) };
          });

          recipesLoaded = true;
          buildIngredientDictionary();

          // byg type-dropdown ud fra tags
          const typeSelect = document.getElementById("typeFilter");
          const sortedTags = Array.from(allTagsSet).sort((a, b) =>
            a.localeCompare(b, "da")
          );
          sortedTags.forEach((tag) => {
            const opt = document.createElement("option");
            opt.value = tag;
            opt.textContent = tag;
            typeSelect.appendChild(opt);
          });

          statusEl.textContent =
            "Indl√¶ste " +
            allRecipes.length +
            (allRecipes.length === 1
              ? " opskrift."
              : " opskrifter.");
        })
        .catch((err) => {
          console.error(err);
          recipesLoaded = false;
          statusEl.textContent =
            "Fejl ved indl√¶sning af recipes.json: " + err.message;
        });
    })();

    document
      .getElementById("addIngredientButton")
      .addEventListener("click", addIngredient);

    document
      .getElementById("ingredientInput")
      .addEventListener("keydown", function (event) {
        if (event.key === "Enter") {
          event.preventDefault();
          addIngredient();
        }
      });

    document
      .getElementById("ingredientInput")
      .addEventListener("input", updateSuggestions);

    document
      .getElementById("clearIngredientsButton")
      .addEventListener("click", clearIngredients);

    document
      .getElementById("allowOneMissing")
      .addEventListener("change", searchRecipes);

    document
      .getElementById("sortOrder")
      .addEventListener("change", searchRecipes);

    document
      .getElementById("typeFilter")
      .addEventListener("change", searchRecipes);

    document.addEventListener("click", (e) => {
      const s = document.getElementById("suggestions");
      const input = document.getElementById("ingredientInput");
      if (!s.contains(e.target) && e.target !== input) {
        hideSuggestions();
      }
    });

    renderIngredientChips();
  </script>
</body>
</html>
